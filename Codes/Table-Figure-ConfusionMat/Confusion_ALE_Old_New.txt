library(readxl)
library(writexl)
library(ggplot2)
library(reshape2)

# File path
file_path <- "V:/CanALE/ALE_INDEX&CLASS/Confusion/Ale_2016.xlsx"

# Load Excel file
data <- read_excel(file_path)

# Convert to factor
data$ALE_index_class <- factor(data$ALE_index_class)
data$ALE_index_class_weighted <- factor(data$ALE_index_class_weighted)
data$ALE_transit_index_class <- factor(data$ALE_transit_index_class)
data$ALE_transit_index_class_weighted <- factor(data$ALE_transit_index_class_weighted)

# Create confusion matrices
conf_ale <- table(Old = data$ALE_index_class, New = data$ALE_index_class_weighted)
conf_transit <- table(Old = data$ALE_transit_index_class, New = data$ALE_transit_index_class_weighted)

# Remove rows and columns with class 0
conf_ale <- conf_ale[rownames(conf_ale) != "0", colnames(conf_ale) != "0"]
conf_transit <- conf_transit[rownames(conf_transit) != "0", colnames(conf_transit) != "0"]

# Convert to data frame for Excel export
conf_ale_df <- as.data.frame.matrix(conf_ale)
conf_transit_df <- as.data.frame.matrix(conf_transit)

# Save to Excel
write_xlsx(list(
  ALE_Class_Confusion = conf_ale_df,
  Transit_Class_Confusion = conf_transit_df
), path = "V:/CanALE/ALE_INDEX&CLASS/Confusion/Confusion_Matrices_Output.xlsx")

# Heatmap plotting
conf_ale_melt <- melt(conf_ale)
conf_transit_melt <- melt(conf_transit)

# Axis labeling
conf_ale_melt$Old <- as.numeric(as.character(conf_ale_melt$Old))
conf_ale_melt$New <- as.numeric(as.character(conf_ale_melt$New))
conf_transit_melt$Old <- as.numeric(as.character(conf_transit_melt$Old))
conf_transit_melt$New <- as.numeric(as.character(conf_transit_melt$New))

# Heatmap for ALE class
ggplot(conf_ale_melt, aes(x = New, y = Old, fill = value)) +
  geom_tile(color = "white") +
  geom_text(aes(label = value), color = "black") +
  scale_fill_gradient(low = "white", high = "steelblue") +
  scale_x_continuous(breaks = 1:5) +
  scale_y_continuous(breaks = 1:5) +
  labs(title = "Confusion Matrix: ALE Class", x = "ALE index (Weighted POI)", y = "ALE index") +
  theme_minimal()

# Heatmap for ALE Transit class
ggplot(conf_transit_melt, aes(x = New, y = Old, fill = value)) +
  geom_tile(color = "white") +
  geom_text(aes(label = value), color = "black") +
  scale_fill_gradient(low = "white", high = "darkgreen") +
  scale_x_continuous(breaks = 1:5) +
  scale_y_continuous(breaks = 1:5) +
  labs(title = "Confusion Matrix: ALE Transit Class", x = "ALE Transit index (Weighted POI)", y = "ALE Transit index") +
  theme_minimal()
