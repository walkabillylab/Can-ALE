library(readxl)
library(dplyr)
library(tidyr)
library(writexl)

# File paths (Adjust the path and years for other census years)
input_path  <- "V:/CanALE/Data/ALE_Index/ALE_2011/ALE_INDEX_2011.xlsx"

output_path <- "V:/CanALE/Data/ALE_Index/ALE_2011/ALE_INDEX_2011_cluster_summary.xlsx"

# Read the data 
df <- read_excel(input_path)

#  Variables to summarise 
numeric_vars <- c(
  "dwel_density", "int_density", "poi", "poi_weighted", "walk_rate", "active_transport_rate",
  "ALE_index"                              
)

# Formatted labels for the table
var_labels <- c(
  dwel_density          = "Weighted dwelling density",
  int_density           = "Three-way intersection density",
  poi                   = "Points of interest",
  poi_weighted          = "Weighted Points of interest",
  walk_rate             = "Walking rate",
  active_transport_rate = "Active Transport Rate",
  ALE_index             = "Active Living Environment index"
)

#  Grouping variable 
group_var <- "ALE_index_class"

# Summary for one data slice 
get_summary <- function(data, group_label) {
  data %>% 
    summarise(across(all_of(numeric_vars), list(
      Count   = ~ sum(!is.na(.)),
      Average = ~ mean(., na.rm = TRUE),
      Minimum = ~ min(., na.rm = TRUE),
      Maximum = ~ max(., na.rm = TRUE)
    ), .names = "{.col}_{.fn}")) %>% 
    pivot_longer(
      everything(),
      names_to  = c("Variable", "Stat"),
      names_sep = "_(?=[^_]+$)"   # split on last underscore
    ) %>% 
    mutate(Group = group_label)
}

# Overall summary for all groups together 
summary_all <- get_summary(df, "All groups")

# Summary for each ALE_index_class (1â€“5) 
summary_by_group <- df %>% 
  filter(!is.na(.data[[group_var]])) %>% 
  group_by(.data[[group_var]]) %>% 
  group_split() %>% 
  lapply(function(group_df) {
    grp_val <- unique(group_df[[group_var]])
    label   <- dplyr::case_when(
      grp_val == 1 ~ "1 (very low)",
      grp_val == 2 ~ "2 (low)",
      grp_val == 3 ~ "3 (moderate)",
      grp_val == 4 ~ "4 (high)",
      grp_val == 5 ~ "5 (very high)",
      TRUE         ~ paste("Group", grp_val)
    )
    get_summary(group_df, label)
  }) %>% 
  bind_rows()

#  Combine and label for the final table 
final_table <- bind_rows(summary_all, summary_by_group) %>% 
  mutate(
    Variable = var_labels[Variable],
    Stat     = factor(Stat, levels = c("Count", "Average", "Minimum", "Maximum"))
  ) %>% 
  arrange(Variable, Stat) %>% 
  pivot_wider(
    names_from  = Group,
    values_from = value,
    values_fn   = mean
  ) %>% 
  rename(Statistic = Stat) %>% 
  mutate(
    Variable_Name = ifelse(Statistic == "Count", Variable, ""),
    .before = Statistic
  ) %>% 
  select(Variable_Name, Statistic, everything(), -Variable)

#  Write to Excel 
write_xlsx(list(Cluster_Summary = final_table), output_path)